<!Doctype html>

<head>
    <meta charset="UTF-8">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
    <link href="external/icon.css" rel="stylesheet">
    <link rel="stylesheet" href="external/materialize.min.css">
    <script src="external/materialize.min.js"></script>
    <script src="js/coms.js"></script>
    <link rel="stylesheet" href="css/main.css">
    <style>
        #score-popup {
            width: 100vw;
            height: 100%;
            display: none;
            z-index: 1;
        }
        
        #scorecard {
            overflow: hidden;
            overflow-y: scroll;
            width: 80vw;
            height: 65vh;
        }
        
        .close {
            font-size: 0.7em;
        }
    </style>
</head>

<body>
    <nav>
        <div class="nav-wrapper green"> <a href="index.html" class="brand-logo">&nbsp;Frolf&nbsp;</a>
            <ul id="nav-mobile" class="right hide-on-med-and-down">
                <li><a href="scores.html">Scores</a></li>
                <li><a href="courses.html">Courses</a></li>
                <li><a href="games.html">Games</a></li>
                <li><a href="peoples.html">People</a></li>
            </ul>
        </div>
    </nav>
    <div id="score-popup" class="ver cent">
        <div>
            <h4 id="c-name">Rundle</h4> </div>
        <div id="scorecard" class="card">
            <ul id="scores" class="collection"> </ul>
        </div>
        <button onclick="window.location.href='index.html'" class="btn orange">Done</button>
    </div>
    <script>
        var game;
        var info;
        window.onload = function () {
            M.AutoInit();
            let data = parseGameInfo();
            game = data.scores;
            info = data.info;
            document.getElementById('c-name').innerHTML = getCourseKeyMap().get(info.course);
            scoreSummary();
            console.log(meta);
            sync();
        }

        function getNameKeyMap() {
            let names = JSON.parse(localStorage.getItem("names"));
            let name_key = new Map();
            for (let name of names) {
                name_key.set(name[1], name[0]);
            }
            return name_key;
        }

        function getCourseKeyMap() {
            let names = JSON.parse(localStorage.getItem("courses"));
            let name_key = new Map();
            for (let name of names) {
                name_key.set(name[0], name[2]);
            }
            for (let c of info.newStuff.courses) {
                name_key.set(c, c);
            }
            return name_key;
        }
        /* Parsing query strings: https://stackoverflow.com/a/901144 */
        function parseGameInfo() {
            var regex = new RegExp("[?&]" + "data".replace(/[\[\]]/g, "\\$&") + "(=([^&#]*)|&|#|$)")
                , results = regex.exec(window.location.href);
            if (!results) return null;
            if (!results[2]) return '';
            return JSON.parse(atob(decodeURIComponent(results[2].replace(/\+/g, " "))));
        }

        function scoreSummary() {
            document.getElementById("scores").innerHTML = "";
            for (let i in game) {
                addScorePlayer(game[i].name, game[i].score);
            }
            document.getElementById('score-popup').style.display = 'flex';
        }

        function addScorePlayer(name, scores) {
            let pid = getNameKeyMap().get(name);
            let handicap = getHandicap(pid);
            let paddedNum = (v, i, a) => {
                if (v < 10) {
                    return "&nbsp;&nbsp;" + v;
                }
                if (v < 100) {
                    return "&nbsp;" + v;
                }
                return "" + v;
            };
            let score_front = scores.slice(0, 9).map(paddedNum);
            let score_back = scores.slice(9, 18).map(paddedNum);
            let total = scores.reduce((a, b) => a + b);
            let li = document.createElement('li');
            li.setAttribute("class", "collection-item ver");
            if (name == "Par") {
                li.innerHTML = `
                    <div class="hor spread">
                        <p>${name}</p>
                        <div class="hor drift">
                            <p>Total:&nbsp;</p>
                            <p>${total}</p>
                        </div>
                    </div>
                    <div>
                        <p class="close">${score_front}</p>
                        <p class="close">${score_back}</p>
                    </div>`;
            }
            else {
                li.innerHTML = `
                    <div class="hor spread">
                        <p>${name}</p>
                        <div class="hor drift">
                            <p>Total:&nbsp;</p>
                            <p>${total}</p>
                        </div>
                        
                    </div>
                    <div>
                        <p class="close">${score_front}</p>
                        <p class="close">${score_back}</p>
                    </div>
                    <div class="hor drift">
                        <div class="hor drift">
                            <p>Handicap:&nbsp;</p>
                            <p>${handicap}</p>
                        </div>
                        <div class="hor drift">
                            <p>Adjusted score:&nbsp;</p>
                            <p>${total - handicap}</p>
                        </div>
                    </div>`;
            }
            document.getElementById("scores").appendChild(li);
        }

        function getHandicap(name) {
            let names = JSON.parse(localStorage.getItem("names"));
            let name_key = new Map();
            for (let name of names) {
                name_key.set(name[0], name[2]);
            }
            return name_key.get(name);
        }
    </script>
</body>