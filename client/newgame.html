<!Doctype html>

<head>
    <meta charset="UTF-8">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-beta/css/materialize.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-beta/js/materialize.min.js"></script>
    <script src="js/coms.js"></script>
    <link rel="stylesheet" href="css/main.css">
    <style>
        #go-btn {
            position: absolute;
            bottom: 0px;
            width: 100vw;
        }
    </style>
</head>

<body>
    <nav>
        <div class="nav-wrapper green"> <a href="index.html" class="brand-logo">&nbsp;Frolf&nbsp;</a>
            <ul id="nav-mobile" class="right hide-on-med-and-down">
                <li><a href="scores.html">Scores</a></li>
                <li><a href="courses.html">Courses</a></li>
                <li><a href="games.html">Games</a></li>
            </ul>
        </div>
    </nav>
    <div>
        <ul class="collapsible">
            <li class="active">
                <div class="collapsible-header">Courses</div>
                <div class="collapsible-body"> Select your course!
                    <ul id="course-selector"> </ul>
                </div>
            </li>
            <li>
                <div class="collapsible-header">People</div>
                <div class="collapsible-body">
                    <ul id="people-selector"> </ul>
                </div>
            </li>
        </ul> <a id="go-btn" onclick="startGame()" class="btn-large waves-effect waves-light orange"><i class="material-icons">golf_course</i></a> </div>
    <script>
        window.onload = function () {
            M.AutoInit();
            for(let course of JSON.parse(localStorage.getItem("courses"))){
                addCourse(course[2]);
            }
            
            for(let name of JSON.parse(localStorage.getItem("names"))){
                addPeople(name[1]);
            }
        }

        function addCourse(name) {
            let tpl = '<li><label><input class="with-gap" name="radio-course" type="radio" /> <span>' + name + '</span> </label></li>';
            document.getElementById("course-selector").innerHTML += tpl;
        }

        function addPeople(name) {
            let tpl = '<li><label><input class="with-gap" name="check-people" type="checkbox" /> <span>' + name + '</span> </label></li>';
            document.getElementById("people-selector").innerHTML += tpl;
        }

        function startGame() {
            let data = {};
            data.players = [];
            var inputs = document.getElementsByTagName('input');
            for (var i = 0; i < inputs.length; i++) {
                if (inputs[i].type.toLowerCase() == 'checkbox') {
                    if (inputs[i].checked) {
                        data.players.push(inputs[i].parentElement.innerText);
                    }
                }
                else if (inputs[i].type.toLowerCase() == 'radio') {
                    if (inputs[i].checked) {
                        data.course = inputs[i].parentElement.innerText;
                    }
                }
            }
           
            let m = getNameKeyMap();
            for(let i in data.players){
                data.players[i] = m.get(data.players[i].trim());
            }
            m = getCourseKeyMap();
            data.course = m.get(data.course.trim());
            
            window.location.href = server+"/game.html?data="+btoa(JSON.stringify(data));
            
        }
        function getNameKeyMap(){
            let names = JSON.parse(localStorage.getItem("names"));
            let name_key = new Map();
            
            for(let name of names){
                name_key.set(name[1], name[0]);
            }
            return name_key;
        }
        
        function getCourseKeyMap(){
            let names = JSON.parse(localStorage.getItem("courses"));
            let name_key = new Map();
            
            for(let name of names){
                name_key.set(name[2], name[0]);
            }
            return name_key;
        }
    </script>
</body>